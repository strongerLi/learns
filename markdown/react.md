

![1650439500125](C:\Users\win 10\AppData\Roaming\Typora\typora-user-images\1650439500125.png)

## ä¸ºä»€ä¹ˆä¼šå‡ºç° React fiber æ¶æ„

 React 15 `Stack Reconciler` æ˜¯é€šè¿‡`é€’å½’`æ›´æ–°å­ç»„ä»¶ ã€‚ç”±äºé€’å½’æ‰§è¡Œï¼Œæ‰€ä»¥æ›´æ–°`ä¸€æ—¦å¼€å§‹`ï¼Œä¸­é€”å°±`æ— æ³•ä¸­æ–­`ã€‚å½“å±‚çº§å¾ˆæ·±æ—¶ï¼Œé€’å½’æ›´æ–°æ—¶é—´è¶…è¿‡äº† `16ms`ï¼Œç”¨æˆ·äº¤äº’å°±ä¼šå¡é¡¿ã€‚ 

åœ¨`setState`åï¼Œreact ä¼šç«‹å³å¼€å§‹`reconciliation`è¿‡ç¨‹ï¼Œä»`çˆ¶èŠ‚ç‚¹`ï¼ˆVirtual DOMï¼‰å¼€å§‹`éå†`ï¼Œä»¥æ‰¾å‡ºä¸åŒã€‚å°†æ‰€æœ‰çš„`Virtual DOMéå†å®Œ`æˆåï¼Œreconciler`æ‰`èƒ½ç»™å‡ºå½“å‰éœ€è¦`ä¿®æ”¹çœŸå®DOMçš„ä¿¡æ¯`ï¼Œå¹¶ä¼ é€’ç»™`renderer`ï¼Œè¿›è¡Œæ¸²æŸ“ï¼Œç„¶åå±å¹•ä¸Šæ‰ä¼šæ˜¾ç¤ºæ­¤æ¬¡`æ›´æ–°`å†…å®¹ã€‚

## React Fiber æ˜¯ä»€ä¹ˆï¼Ÿ

å®˜æ–¹çš„ä¸€å¥è¯è§£é‡Šæ˜¯â€œ`React Fiberæ˜¯å¯¹æ ¸å¿ƒç®—æ³•çš„ä¸€æ¬¡é‡æ–°å®ç°`â€ã€‚Fiber æ¶æ„è°ƒæ•´å¾ˆæ—©å°±å®˜å®£äº†ï¼Œä½†å®˜æ–¹ç»è¿‡ä¸¤å¹´æ—¶é—´æ‰åœ¨`V16ç‰ˆæœ¬`æ­£å¼å‘å¸ƒã€‚å®˜æ–¹æ¦‚å¿µè§£é‡Šå¤ªç¬¼ç»Ÿï¼Œ å…¶å®ç®€å•æ¥è¯´ `React Fiber` æ˜¯ä¸€ä¸ª`æ–°çš„ä»»åŠ¡è°ƒå’Œå™¨`ï¼ˆ`Reconciliation`ï¼‰ç®€ç§°`åè°ƒ`

ç®€å•ç†è§£å°±æ˜¯æŠŠä¸€ä¸ª`è€—æ—¶é•¿çš„ä»»åŠ¡`åˆ†è§£ä¸ºä¸€ä¸ªä¸ªçš„å·¥ä½œå•å…ƒï¼ˆæ¯ä¸ªå·¥ä½œå•å…ƒè¿è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œä¸è¿‡æ€»æ—¶é—´ä¾ç„¶å¾ˆé•¿ï¼‰ã€‚åœ¨æ‰§è¡Œå·¥ä½œå•å…ƒä¹‹å‰ï¼Œç”±`æµè§ˆå™¨åˆ¤æ–­æ˜¯å¦æœ‰ç©ºä½™æ—¶é—´æ‰§è¡Œ`ï¼Œ`æœ‰æ—¶é—´å°±æ‰§è¡Œ`å·¥ä½œå•å…ƒï¼Œæ‰§è¡Œå®Œæˆåï¼Œç»§ç»­åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ç©ºé—²æ—¶é—´ã€‚`æ²¡æœ‰æ—¶é—´å°±ç»ˆæ­¢æ‰§è¡Œ`è®©æµè§ˆå™¨æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼ˆå¦‚ GUI çº¿ç¨‹ç­‰ï¼‰ã€‚ç­‰åˆ°ä¸‹ä¸€å¸§æ‰§è¡Œæ—¶åˆ¤æ–­æ˜¯å¦æœ‰ç©ºä½™æ—¶é—´ï¼Œæœ‰æ—¶é—´å°±ä»ç»ˆæ­¢çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œå·¥ä½œå•å…ƒ,`ä¸€ç›´é‡å¤`åˆ°ä»»åŠ¡ç»“æŸã€‚

> `Fiberæ¶æ„` = `FiberèŠ‚ç‚¹` + `Fiberè°ƒåº¦ç®—æ³•` 

è¦è®©ç»ˆæ­¢çš„ä»»åŠ¡`æ¢å¤æ‰§è¡Œ`ï¼Œå°±å¿…é¡»çŸ¥é“`ä¸‹ä¸€å·¥ä½œå•å…ƒ`å¯¹åº”é‚£ä¸€ä¸ªã€‚æ‰€ä»¥è¦å®ç°å·¥ä½œå•å…ƒçš„è¿æ¥ï¼Œå°±è¦ä½¿ç”¨`é“¾è¡¨`ï¼Œåœ¨æ¯ä¸ªå·¥ä½œå•å…ƒä¸­`ä¿å­˜ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒçš„æŒ‡é’ˆ`ï¼Œå°±èƒ½æ¢å¤ä»»åŠ¡çš„æ‰§è¡Œã€‚

è¦çŸ¥é“æ¯ä¸€å¸§çš„ç©ºé—²æ—¶é—´ï¼Œå°±éœ€è¦ä½¿ç”¨ `requestIdleCallback` Apiã€‚ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼ˆå‰©ä½™æ—¶é—´ï¼‰ï¼Œå¦‚æœæœ‰å‰©ä½™æ—¶é—´ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œå·¥ä½œå•å…ƒï¼Œå¦‚æœæ—¶é—´ä¸è¶³äº†ï¼Œåˆ™ç»§ç»­`requestIdleCallback`ï¼Œç­‰åˆ°ä¸‹ä¸€å¸§ç»§ç»­åˆ¤æ–­ã€‚

>  ğŸ“š`æ‰€ä»¥ Fiber æ¶æ„å°±æ˜¯ç”¨ å¼‚æ­¥çš„æ–¹å¼è§£å†³æ—§ç‰ˆæœ¬ åŒæ­¥é€’å½’å¯¼è‡´çš„æ€§èƒ½é—®é¢˜`ã€‚ 

`requestIdleCallback`è¢«Reacté‡å†™äº†ï¼Œä½¿ç”¨åˆ°çš„åº•å±‚APIä¸»è¦æ˜¯ requestAnimationFrame å’Œ MessageChannel



å¦‚ä½•å®ç°ä¸­æ–­ç»§ç»­

```javascript

if(fiber.child) {
    return fiber.child
}

let nextFiber = fiber

while(nextFiber) {
    if(nexNode.sibling) {
        return nextFiber.sibling
    }
    nextFiber = nextFiber.return
}
```



## react-router

å•é¡µé¢åº”ç”¨è·¯ç”±å®ç°åŸç†æ˜¯ï¼Œåˆ‡æ¢urlï¼Œç›‘å¬urlå˜åŒ–ï¼Œä»è€Œæ¸²æŸ“ä¸åŒçš„é¡µé¢ç»„ä»¶ã€‚

ä¸»è¦çš„æ–¹å¼æœ‰`history`æ¨¡å¼å’Œ`hash`æ¨¡å¼ã€‚

### 1 historyæ¨¡å¼åŸç†

#### â‘ æ”¹å˜è·¯ç”±

```
**history.pushState**
history.pushState(state,title,path)
å¤åˆ¶ä»£ç 
```

1 `**state**`ï¼šä¸€ä¸ªä¸æŒ‡å®šç½‘å€ç›¸å…³çš„çŠ¶æ€å¯¹è±¡ï¼Œ popstate äº‹ä»¶è§¦å‘æ—¶ï¼Œè¯¥å¯¹è±¡ä¼šä¼ å…¥å›è°ƒå‡½æ•°ã€‚å¦‚æœä¸éœ€è¦å¯å¡« nullã€‚

2 `**title**`ï¼šæ–°é¡µé¢çš„æ ‡é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰æµè§ˆå™¨ç›®å‰éƒ½å¿½ç•¥è¿™ä¸ªå€¼ï¼Œå¯å¡« nullã€‚

3 `**path**`ï¼šæ–°çš„ç½‘å€ï¼Œå¿…é¡»ä¸å½“å‰é¡µé¢å¤„åœ¨åŒä¸€ä¸ªåŸŸã€‚æµè§ˆå™¨çš„åœ°å€æ å°†æ˜¾ç¤ºè¿™ä¸ªåœ°å€ã€‚

```
**history.replaceState**
history.replaceState(state,title,path)
å¤åˆ¶ä»£ç 
```

å‚æ•°å’Œ`pushState`ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¿®æ”¹å½“å‰çš„` history `å¯¹è±¡è®°å½•ï¼Œ `history.length` çš„é•¿åº¦ä¸ä¼šæ”¹å˜ã€‚

#### â‘¡ç›‘å¬è·¯ç”±

```
**popstateäº‹ä»¶**
window.addEventListener('popstate',function(e){
    /* ç›‘å¬æ”¹å˜ */
})
å¤åˆ¶ä»£ç 
```

åŒä¸€ä¸ªæ–‡æ¡£çš„ `history` å¯¹è±¡å‡ºç°å˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘` popstate` äº‹ä»¶  `history.pushState` å¯ä»¥ä½¿æµè§ˆå™¨åœ°å€æ”¹å˜ï¼Œä½†æ˜¯æ— éœ€åˆ·æ–°é¡µé¢ã€‚**æ³¨æ„âš ï¸çš„æ˜¯ï¼šç”¨ `history.pushState()` æˆ–è€… `history.replaceState()` ä¸ä¼šè§¦å‘ `popstate` äº‹ä»¶**ã€‚ `popstate` äº‹ä»¶åªä¼šåœ¨æµè§ˆå™¨æŸäº›è¡Œä¸ºä¸‹è§¦å‘, æ¯”å¦‚ç‚¹å‡»åé€€ã€å‰è¿›æŒ‰é’®æˆ–è€…è°ƒç”¨ `history.back()ã€history.forward()ã€history.go()`æ–¹æ³•ã€‚

### 2 hashæ¨¡å¼åŸç†

#### â‘ æ”¹å˜è·¯ç”±

```
**window.location.hash**
```

é€šè¿‡`window.location.hash ` å±æ€§è·å–å’Œè®¾ç½® `hash `å€¼ã€‚

#### â‘¡ç›‘å¬è·¯ç”±

```
**onhashchange**
window.addEventListener('hashchange',function(e){
    /* ç›‘å¬æ”¹å˜ */
})
```

![1650527991864](C:\Users\win 10\AppData\Roaming\Typora\typora-user-images\1650527991864.png)

### hooksä¸ºä»€ä¹ˆè¦å†™åˆ°æœ€å¤–è¾¹

- hookså¿…é¡»æŒ‰ç…§ç»Ÿä¸€çš„é¡ºåºæ‰§è¡Œï¼Œå› ä¸ºæ¯è°ƒç”¨ä¸€ä¸ªhookséƒ½ä¼šåœ¨è¯¥ç»„ä»¶çš„hooksåˆ—è¡¨ä¸­pushä¸€æ¡æ•°æ®ï¼Œç”¨äºè®°å½•ä¸Šæ¬¡çš„æ•°æ®
- ç»„ä»¶æ›´æ–°ï¼Œhookså†æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§è°ƒç”¨çš„é¡ºåºä½œä¸ºindexæ¥å¯¹æ¯”hooksåˆ—è¡¨ä¸­çš„æ•°æ®å¯¹æ¯”ï¼Œæ­¤æ—¶indexè¦ä¿è¯ä¸€ä¸€å¯¹åº”
- å¦‚æœåœ¨æ¡ä»¶è¯­å¥ä¸­å¼•ç”¨hooksï¼Œæ¯æ¬¡æ¡ä»¶ä¸åŒï¼Œé‚£ä¹ˆhooksæ‰§è¡Œçš„é¡ºåºå°±ä¼šä¸ä¸€è‡´ï¼Œå¯¹æ¯”æ•°æ®å°±ä¼šå‡ºç°é¡ºåºæ··ä¹±
- hooksä¸åœ¨æœ€å¤–å±‚è°ƒç”¨çš„æ—¶å€™ï¼Œreactä¼šæŠ¥é”™ã€‚

## Redux

```
function createStore(reducer) {
 let currentState
 let subscribers = []

 function dispatch(action) {
   currentState = reducer(currentState, action);
   subscribers.forEach(s => s())
 }

 function getState() {
   return currentState;
 }

 function subscribe(subscriber) {
     subscribers.push(subscriber)
     return function unsubscribe() {
         ...
     }
 }

 dispatch({ type: 'INIT' });

 return {
   dispatch,
   getState,
 };
}
```

# React ä¸­ setState ä»€ä¹ˆæ—¶å€™æ˜¯åŒæ­¥çš„ï¼Œä»€ä¹ˆæ—¶å€™æ˜¯å¼‚æ­¥çš„ï¼Ÿ

åœ¨Reactä¸­ï¼Œ**å¦‚æœæ˜¯ç”±Reactå¼•å‘çš„äº‹ä»¶å¤„ç†ï¼ˆæ¯”å¦‚é€šè¿‡onClickå¼•å‘çš„äº‹ä»¶å¤„ç†ï¼‰ï¼Œè°ƒç”¨setStateä¸ä¼šåŒæ­¥æ›´æ–°this.stateï¼Œé™¤æ­¤ä¹‹å¤–çš„setStateè°ƒç”¨ä¼šåŒæ­¥æ‰§è¡Œthis.state** ã€‚æ‰€è°“â€œé™¤æ­¤ä¹‹å¤–â€ï¼ŒæŒ‡çš„æ˜¯ç»•è¿‡Reacté€šè¿‡addEventListenerç›´æ¥æ·»åŠ çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¿˜æœ‰é€šè¿‡setTimeout/setIntervaläº§ç”Ÿçš„å¼‚æ­¥è°ƒç”¨ã€‚

**åŸå› ï¼š** åœ¨Reactçš„setStateå‡½æ•°å®ç°ä¸­ï¼Œä¼šæ ¹æ®ä¸€ä¸ªå˜é‡isBatchingUpdatesåˆ¤æ–­æ˜¯ç›´æ¥æ›´æ–°this.stateè¿˜æ˜¯æ”¾åˆ°é˜Ÿåˆ—ä¸­å›å¤´å†è¯´ï¼Œè€ŒisBatchingUpdatesé»˜è®¤æ˜¯falseï¼Œä¹Ÿå°±è¡¨ç¤ºsetStateä¼šåŒæ­¥æ›´æ–°this.stateï¼Œä½†æ˜¯ï¼Œ**æœ‰ä¸€ä¸ªå‡½æ•°batchedUpdatesï¼Œè¿™ä¸ªå‡½æ•°ä¼šæŠŠisBatchingUpdatesä¿®æ”¹ä¸ºtrueï¼Œè€Œå½“Reactåœ¨è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°ä¹‹å‰å°±ä¼šè°ƒç”¨è¿™ä¸ªbatchedUpdatesï¼Œé€ æˆçš„åæœï¼Œå°±æ˜¯ç”±Reactæ§åˆ¶çš„äº‹ä»¶å¤„ç†è¿‡ç¨‹setStateä¸ä¼šåŒæ­¥æ›´æ–°this.state**ã€‚

**æ³¨æ„ï¼š** setStateçš„â€œå¼‚æ­¥â€å¹¶ä¸æ˜¯è¯´å†…éƒ¨ç”±å¼‚æ­¥ä»£ç å®ç°ï¼Œå…¶å®æœ¬èº«æ‰§è¡Œçš„è¿‡ç¨‹å’Œä»£ç éƒ½æ˜¯åŒæ­¥çš„ï¼Œåªæ˜¯åˆæˆäº‹ä»¶å’Œé’©å­å‡½æ•°çš„è°ƒç”¨é¡ºåºåœ¨æ›´æ–°ä¹‹å‰ï¼Œå¯¼è‡´åœ¨åˆæˆäº‹ä»¶å’Œé’©å­å‡½æ•°ä¸­æ²¡æ³•ç«‹é©¬æ‹¿åˆ°æ›´æ–°åçš„å€¼ï¼Œå½¢å¼äº†æ‰€è°“çš„â€œå¼‚æ­¥â€ï¼Œå½“ç„¶å¯ä»¥é€šè¿‡ç¬¬äºŒä¸ªå‚æ•° setState(partialState, callback) ä¸­çš„callbackæ‹¿åˆ°æ›´æ–°åçš„ç»“æœã€‚

```js
class Example extends React.Component {
  constructor() {
    super();
    this.state = {
      val: 0
    };
  }
  
  componentDidMount() {
    this.setState({val: this.state.val + 1});
    console.log(this.state.val);    // ç¬¬ 1 æ¬¡ log

    this.setState({val: this.state.val + 1});
    console.log(this.state.val);    // ç¬¬ 2 æ¬¡ log

    setTimeout(() => {
      this.setState({val: this.state.val + 1});
      console.log(this.state.val);  // ç¬¬ 3 æ¬¡ log

      this.setState({val: this.state.val + 1});
      console.log(this.state.val);  // ç¬¬ 4 æ¬¡ log
    }, 0);
  }

  render() {
    return null;
  }
};
```

1ã€ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡éƒ½æ˜¯åœ¨ react è‡ªèº«ç”Ÿå‘½å‘¨æœŸå†…ï¼Œè§¦å‘æ—¶ isBatchingUpdates ä¸º trueï¼Œæ‰€ä»¥å¹¶ä¸ä¼šç›´æ¥æ‰§è¡Œæ›´æ–° stateï¼Œè€Œæ˜¯åŠ å…¥äº† dirtyComponentsï¼Œæ‰€ä»¥æ‰“å°æ—¶è·å–çš„éƒ½æ˜¯æ›´æ–°å‰çš„çŠ¶æ€ 0ã€‚

2ã€ä¸¤æ¬¡ setState æ—¶ï¼Œè·å–åˆ° this.state.val éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥æ‰§è¡Œæ—¶éƒ½æ˜¯å°† 0 è®¾ç½®æˆ 1ï¼Œåœ¨ react å†…éƒ¨ä¼šè¢«åˆå¹¶æ‰ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚è®¾ç½®å®Œæˆå state.val å€¼ä¸º 1ã€‚

3ã€setTimeout ä¸­çš„ä»£ç ï¼Œè§¦å‘æ—¶ isBatchingUpdates ä¸º falseï¼Œæ‰€ä»¥èƒ½å¤Ÿç›´æ¥è¿›è¡Œæ›´æ–°ï¼Œæ‰€ä»¥è¿ç€è¾“å‡º 2ï¼Œ3ã€‚

è¾“å‡ºï¼š 0 0 2 3

